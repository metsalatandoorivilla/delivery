<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Delivery Drivers Log â€“ Ravintola Tandoori Villa</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>
  <style>
    :root {
      --main-bg: linear-gradient(135deg, #0d47a1 0%, #000 100%);
      --card-bg: #181c24;
      --primary: #42a5f5;
      --primary-hover: #1976d2;
      --accent: #bbdefb;
      --border: #212a40;
      --red: #ff3b30;
      --gap: 24px;
      --card-radius: 15px;
    }
    html, body {
      min-height: 100vh;
      margin: 0;
      padding: 0;
      background: var(--main-bg);
      box-sizing: border-box;
      width: 100vw;
      font-family: 'Poppins', Arial, sans-serif;
      color: #fff;
      overflow-x: hidden;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }
    body {
      width: 100vw;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      margin: 0;
      padding: 0;
    }
    .page-wrapper {
      width: 100vw;
      max-width: 100vw;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: flex-start;
      padding: 0;
      box-sizing: border-box;
    }
    .header {
      width: 100%;
      background: var(--card-bg);
      color: var(--accent);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 19px 16px 12px 16px;
      margin: 0 0 var(--gap) 0;
      margin-top: 24px;
      border-radius: var(--card-radius);
      box-shadow: 0 2px 9px rgba(66, 165, 245, 0.08);
      min-height: 43px;
      letter-spacing: 0.03em;
      max-width: 1100px;
      align-self: center;
    }
    .header-row {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .header-title {
      font-size: 1.17rem;
      font-weight: 800;
      color: #fff;
      font-family: 'Poppins', Arial, sans-serif;
      letter-spacing: 0.03em;
      text-shadow: 0 2px 12px #009de044;
      white-space: nowrap;
      flex: none;
      display: inline-flex;
      align-items: center;
      gap: 0.6em;
    }
    .header-desc {
      font-size: 0.99em;
      font-weight: 500;
      color: #bbdefb;
      opacity: 0.88;
      margin-left: 18px;
      font-family: 'Poppins', Arial, sans-serif;
      letter-spacing: 0.01em;
      text-align: center;
      flex: none;
      display: inline-block;
      white-space: normal;
      max-width: 68vw;
    }
    .header-btnbar { 
      display: flex; 
      gap: 16px; 
      margin-top: 12px; 
      margin-bottom: 0; 
    }
    .header-btnbar button { 
      font-size: 1em; 
      font-family: 'Poppins', Arial, sans-serif; 
      font-weight: 700; 
      background: var(--primary); 
      color: #fff; 
      border: none; 
      border-radius: 9px; 
      padding: 8px 20px; 
      cursor: pointer; 
      transition: background 0.16s;
    }
    .header-btnbar button:hover { background: var(--primary-hover);}
    .header-btnbar .logout-btn { background: var(--red);}
    .header-btnbar .logout-btn:hover { background: #c11;}
    .header-btnbar .reports-btn { background: var(--primary);}
    .driver-addbar {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.45em;
      margin: 13px 0 16px 0;
      width: 100%;
      max-width: 600px;
      padding: 0 3px;
      align-self: center;
    }
    .driver-addbar input[type="text"] {
      flex: 1;
      font-size: 1em;
      padding: 0.55em 1em;
      background: #212a40;
      border: none;
      border-radius: 9px;
      color: var(--accent);
      outline: none;
      font-family: 'Poppins', Arial, sans-serif;
      font-weight: 600;
      margin-right: 0.07em;
    }
    .driver-addbar button {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 9px;
      font-size: 0.97rem;
      font-weight: 700;
      padding: 7px 18px;
      cursor: pointer;
      transition: background 0.16s;
      font-family: inherit;
      letter-spacing: 0.01em;
      display: flex;
      align-items: center;
      gap: 0.22em;
    }
    .driver-addbar button:hover { background: var(--primary-hover);}
    .log-board {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--gap);
      width: 100vw;
      max-width: 1100px;
      align-items: stretch;
      margin: 0 auto 17px auto;
      padding: 0 12px;
      box-sizing: border-box;
      justify-items: center;
      overflow-x: hidden;
    }
    .driver-card {
      background: var(--card-bg);
      border-radius: var(--card-radius);
      box-shadow: 0 2px 8px rgba(66,165,245,0.08);
      border: 2px solid var(--border);
      padding: 0;
      display: flex;
      flex-direction: column;
      min-width: 0;
      max-width: 100%;
      font-size: 0.97rem;
      position: relative;
      margin-bottom: 0;
      margin-top: 16px;
      margin-bottom: 16px;
      word-break: break-word;
      transition: border 0.13s, box-shadow 0.13s;
      width: 100%;
      box-sizing: border-box;
    }
    .driver-card.active {
      border: 2.2px solid var(--primary);
      box-shadow: 0 2px 12px #42a5f52a;
    }
    .driver-card-header {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 12px 18px 8px 18px;
      background: #0d47a1;
      color: var(--accent);
      font-size: 1.07em;
      font-weight: 700;
      gap: 14px;
      border-bottom: 1px solid var(--border);
      border-top-left-radius: var(--card-radius);
      border-top-right-radius: var(--card-radius);
      box-sizing: border-box;
      flex-wrap: nowrap;
    }
    .driver-card-header .driver-name {
      font-size: 1.08em;
      font-weight: 700;
      color: #fff;
      flex: 1 1 auto;
      min-width: 0;
      letter-spacing: 0.04em;
      overflow-wrap: break-word;
      word-break: break-word;
      white-space: normal;
      display: inline-block;
      margin-right: 10px;
    }
    .driver-card-header .driver-date {
      font-size: 0.97em;
      color: #d5f5ff;
      background: #183350;
      border-radius: 0.5em;
      padding: 3px 8px;
      border: none;
      outline: none;
      font-family: inherit;
      font-weight: 600;
      width: 120px;
      min-width: 120px;
      max-width: 160px;
      text-align: center;
      flex-shrink: 0;
      margin-right: 10px;
      position: relative;
      z-index: 1;
      cursor: pointer;
    }
    .driver-card-header .driver-date[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer;}
    .driver-card-header .driver-delete { color: var(--red); font-size: 1.14em; border: none; background: none; cursor: pointer; margin-left: auto; border-radius: 50%; padding: 0.07em 0.36em; transition: background 0.11s; flex-shrink: 0;}
    .driver-fields-row { display: flex; align-items: center; gap: 0.7em; margin: 13px 0 3px 0; padding: 0 15px; justify-content: stretch;}
    .driver-fields-row label { font-size: 1em; font-weight: 600; color: #bbdefb; margin-right: 0; padding-right: 0; font-family: inherit; white-space: nowrap;}
    .input-km-wrap { display: inline-flex; align-items: center; border-radius: 7px; background: #212a40; box-shadow: 0 1px 4px #009de018; margin: 0 0.15em; padding-left: 0.15em; padding-right: 0.2em;}
    .input-km-wrap input[type="number"] { width: 5.5em; font-size: 1.07em; padding: 0.42em 0.12em 0.42em 0.55em; background: #212a40; border: 1px solid #384164; border-radius: 7px 0 0 7px; color: #fff; outline: none; text-align: center; font-family: inherit; font-weight: 700; white-space: nowrap; box-shadow: none;}
    .input-km-wrap .km-unit { font-size: 0.98em; color: #7ec5fd; margin-left: 0.2em; margin-right: 0.3em; font-weight: 700; white-space: nowrap; background: transparent; border: none; padding: 0; pointer-events: none; user-select: none;}
    .driver-km-result { margin: 0 0 2px 0; font-size: 1.08em; font-weight: 700; color: var(--primary); font-family: inherit; letter-spacing: 0.04em; text-align: left; padding: 0 15px; min-height: 21px; display: flex; align-items: center; gap: 0.4em;}
    .driver-timer-bar { display: flex; align-items: center; gap: 0.6em; margin: 0 0 2px 0; min-height: 1.4em; padding: 0 15px;}
    .driver-timer { font-size: 1.08em; font-weight: 800; color: #ffc107; background: #212a40; border-radius: 7px; padding: 2px 14px; min-width: 4.6em; text-align: center; letter-spacing: 0.025em; font-family: inherit; border: 1.1px solid #009de055; box-shadow: 0 1px 7px #009de022;}
    .driver-btns { display: flex; gap: 0.7em; margin-top: 8px; padding: 0 15px 15px 15px;}
    .driver-btns button { flex: 1 1 0; font-size: 1.03em; font-weight: 700; border: none; border-radius: 9px; padding: 0.65em 0; background: linear-gradient(90deg,var(--primary),var(--primary-hover)); color: #fff; box-shadow: 0 1px 4px rgba(66,165,245,0.09); cursor: pointer; letter-spacing: 0.04em; transition: background 0.13s; min-width: 0; font-family: inherit;}
    .driver-btns button:active { background: var(--primary-hover);}
    .driver-btns .stop-btn { background: linear-gradient(90deg,#ff3b30 30%,#c11 100%); color: #fff; font-family: inherit;}
    .driver-btns .stop-btn:active { background: #ff3b30;}
    .driver-btns .disabled, .driver-btns button:disabled { opacity: 0.5; pointer-events: none;}
    .how-to-use { width: 100vw; max-width: 1050px; margin: 18px auto 0 auto; padding: 13px 14px 11px 14px; background: #161a23cc; border-radius: 10px; color: #bbdefb; font-size: 0.97em; font-family: 'Poppins', Arial, sans-serif; text-align: left; line-height: 1.6; letter-spacing: 0.01em; box-shadow: 0 2px 8px #212a4033; box-sizing: border-box; overflow-x: hidden; align-self: center;}
    @media (max-width: 1100px) { .log-board { max-width: 99vw; } .driver-card { min-width: 0; max-width: 99vw; } }
    @media (max-width: 900px) { .log-board { grid-template-columns: 1fr; padding: 0 8px; gap: 16px; } .driver-card { min-width: 98vw; max-width: 98vw; font-size: 0.97em; } }
    @media (max-width: 600px) {
      html, body { font-size: 15px; }
      .log-board { grid-template-columns: 1fr; padding: 0 2px; gap:16px;}
      .driver-card { min-width: 99vw; max-width: 99vw; font-size: 0.96em;}
      .driver-card-header .driver-date { width: 130px; min-width: 120px; max-width: 140px; font-size: 1.05em; }
    }
    @media (max-width: 450px) {
      html, body { font-size: 14px; }
      .driver-card-header, .driver-fields-row, .driver-btns, .driver-km-result, .driver-timer-bar {padding-left:4px;padding-right:4px;}
      .driver-card { font-size: 0.93em;}
    }
    .modal-bg { display: none; position: fixed; z-index: 500; top: 0; left: 0; right: 0; bottom: 0; width: 100vw; height: 100vh; background: rgba(13, 32, 70, 0.82); align-items: center; justify-content: center;}
    .modal-bg.active { display: flex;}
    .modal-content { background: var(--card-bg); color: var(--accent); border-radius: 18px; border: 2px solid var(--primary); box-shadow: 0 7px 32px #42a5f547; padding: 28px 30px 22px 30px; display: flex; flex-direction: column; align-items: center; min-width: 270px; max-width: 95vw; min-height: 135px; font-family: 'Poppins', Arial, sans-serif; animation: pop .18s cubic-bezier(.45,1.4,.68,1.02); position: relative;}
    .modal-title { font-size: 1.12em; font-weight: 700; color: #fff; margin-bottom: 9px; text-align: center; letter-spacing: 0.02em;}
    .modal-details { margin-bottom: 16px; color: var(--accent); font-size: 1em; font-weight: 500; text-align: center; word-break: break-word;}
    .modal-done-btn { background: var(--primary); color: #fff; border: none; border-radius: 10px; font-size: 1.01em; font-weight: 700; padding: 10px 34px; cursor: pointer; transition: background 0.18s; margin-top: 2px; font-family: inherit; box-shadow: 0 2px 8px #42a5f533; letter-spacing: 0.03em;}
    .modal-done-btn:hover { background: var(--primary-hover);}
    .modal-close { position: absolute; top: 11px; right: 16px; background: none; border: none; color: #bbdefb; font-size: 1.22em; cursor: pointer; padding: 0; border-radius: 50%; transition: background 0.12s;}
    .modal-close:active { background: #212a40;}
    @keyframes pop { from { transform: scale(0.91); opacity: 0.3;} to   { transform: scale(1);    opacity: 1;} }
    .modal-confirm { background: var(--card-bg); color: var(--accent); border-radius: 18px; border: 2px solid var(--red); box-shadow: 0 7px 32px #ff3b3047; padding: 22px 24px 18px 24px; display: flex; flex-direction: column; align-items: center; min-width: 230px; max-width: 95vw; min-height: 80px; font-family: 'Poppins', Arial, sans-serif; position: relative; animation: pop .18s cubic-bezier(.45,1.4,.68,1.02);}
    .modal-confirm-title { font-size: 1.09em; font-weight: 700; color: #fff; margin-bottom: 9px; text-align: center; letter-spacing: 0.02em;}
    .modal-confirm-details { margin-bottom: 16px; color: var(--accent); font-size: 1em; font-weight: 500; text-align: center; word-break: break-word;}
    .modal-confirm-btns { display: flex; gap: 18px; margin-top: 5px;}
    .modal-confirm-btn { background: var(--red); color: #fff; border: none; border-radius: 10px; font-size: 1.01em; font-weight: 700; padding: 7px 22px; cursor: pointer; transition: background 0.18s; font-family: inherit; box-shadow: 0 2px 8px #ff3b3033; letter-spacing: 0.03em;}
    .modal-confirm-btn:hover { background: #c11;}
    .modal-cancel-btn { background: var(--border); color: #bbdefb; border: none; border-radius: 10px; font-size: 1.01em; font-weight: 700; padding: 7px 22px; cursor: pointer; transition: background 0.18s; font-family: inherit; box-shadow: 0 2px 8px #212a4033; letter-spacing: 0.03em;}
  </style>
</head>
<body>
  <div class="page-wrapper">
    <div class="header">
      <div class="header-row">
        <span class="header-title">
          <i class="fas fa-car"></i> Delivery Drivers Log
        </span>
        <span class="header-desc">
          Ravintola Tandoori Villa &nbsp;|&nbsp; Log car drivers' shift kilometers and time daily
        </span>
      </div>
      <div class="header-btnbar">
        <button class="reports-btn" id="showReportsBtn"><i class="fas fa-road"></i> Show KM Reports</button>
        <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
      </div>
    </div>
    <div class="log-board" id="driverBoard"></div>
    <div class="how-to-use" id="howToUse">
      <b>How to use:</b><br>
      1. Enter your shift's starting kilometers and press <b>Start</b>.<br>
      2. Enter your ending kilometers and press <b>Stop</b>.<br>
      3. See your shift summary and review reports.<br>
      <hr>
      <b>Note:</b> Only the logged-in driver can view and log their own shift.
    </div>
    <div class="modal-bg" id="modalBg">
      <div class="modal-content" id="modalContent">
        <button class="modal-close" id="modalClose" title="Close">&times;</button>
        <div class="modal-title"><i class="fas fa-check-circle" style="color:var(--primary);"></i> Shift Log Saved</div>
        <div class="modal-details" id="modalDetails"></div>
        <button class="modal-done-btn" id="modalDone">Done</button>
      </div>
    </div>
    <div class="modal-bg" id="confirmModalBg">
      <div class="modal-confirm" id="confirmModalContent">
        <div class="modal-confirm-title"><i class="fas fa-exclamation-triangle" style="color:var(--red);"></i> Confirm Delete</div>
        <div class="modal-confirm-details" id="confirmModalDetails"></div>
        <div class="modal-confirm-btns">
          <button class="modal-confirm-btn" id="confirmDeleteBtn">Delete</button>
          <button class="modal-cancel-btn" id="cancelDeleteBtn">Cancel</button>
        </div>
      </div>
    </div>
    <div class="modal-bg" id="logoutModalBg">
      <div class="modal-confirm" id="logoutModalContent">
        <div class="modal-confirm-title"><i class="fas fa-sign-out-alt" style="color:var(--primary);"></i> Confirm Logout</div>
        <div class="modal-confirm-details" id="logoutModalDetails">Are you sure you want to logout?</div>
        <div class="modal-confirm-btns">
          <button class="modal-confirm-btn" id="confirmLogoutBtn">Logout</button>
          <button class="modal-cancel-btn" id="cancelLogoutBtn">Cancel</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    // Auth check
    const userData = JSON.parse(localStorage.getItem("user") || "null");
    if (!userData) { window.location.href = "login.html"; }
    const isAdmin = userData.role === "admin";
    const currentUser = userData.name;

    // Firebase setup
    const firebaseConfig = {
      apiKey: "AIzaSyCirYQ_46JiSkMIwCNs1nSi89dvB1MUg_A",
      authDomain: "deliverylog12.firebaseapp.com",
      databaseURL: "https://deliverylog12-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "deliverylog12",
      storageBucket: "deliverylog12.firebasestorage.app",
      messagingSenderId: "19081371357",
      appId: "1:19081371357:web:b9b59e732a4d90d4d44534",
      measurementId: "G-FSZXXZQSL0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let allUsers = {};
    let driverState = {};

    // Modal logic (unchanged)
    function showModal(details) {
      document.getElementById('modalDetails').innerHTML = details;
      document.getElementById('modalBg').classList.add('active');
      setTimeout(() => { document.getElementById('modalDone').focus(); }, 100);
    }
    function hideModal() { document.getElementById('modalBg').classList.remove('active'); }
    document.getElementById('modalClose').onclick = hideModal;
    document.getElementById('modalDone').onclick = hideModal;
    document.getElementById('modalBg').onclick = function(e) { if (e.target === document.getElementById('modalBg')) hideModal(); };

    function showConfirmModal(userId, userName) {
      document.getElementById('confirmModalDetails').innerHTML = `Are you sure you want to delete <b>${userName}</b>? This cannot be undone.`;
      document.getElementById('confirmModalBg').classList.add('active');
      pendingDeleteDriverId = userId;
      setTimeout(() => { document.getElementById('confirmDeleteBtn').focus(); }, 100);
    }
    function hideConfirmModal() { document.getElementById('confirmModalBg').classList.remove('active'); pendingDeleteDriverId = null; }
    document.getElementById('cancelDeleteBtn').onclick = hideConfirmModal;
    document.getElementById('confirmModalBg').onclick = function(e) { if (e.target === document.getElementById('confirmModalBg')) hideConfirmModal(); };
    document.getElementById('confirmDeleteBtn').onclick = function() {
      if (pendingDeleteDriverId) {
        db.ref("users/" + pendingDeleteDriverId).remove();
        db.ref("driverStates/" + pendingDeleteDriverId).remove();
        hideConfirmModal();
      }
    };
    let pendingDeleteDriverId = null;

    document.getElementById("showReportsBtn").onclick = () => { window.location.href = "reports.html"; };
    document.getElementById("logoutBtn").onclick = () => { document.getElementById("logoutModalBg").classList.add('active'); setTimeout(() => { document.getElementById("confirmLogoutBtn").focus(); }, 100);}
    document.getElementById("cancelLogoutBtn").onclick = () => { document.getElementById("logoutModalBg").classList.remove('active'); };
    document.getElementById("logoutModalBg").onclick = function(e) { if (e.target === document.getElementById("logoutModalBg")) document.getElementById("logoutModalBg").classList.remove('active'); };
    document.getElementById("confirmLogoutBtn").onclick = function() { localStorage.removeItem('user'); window.location.href = "login.html"; };

    db.ref("users").on("value", snap => {
      allUsers = snap.val() || {};
      renderDrivers();
    });

    db.ref("driverStates").on("value", snap => {
      const states = snap.val() || {};
      Object.entries(states).forEach(([userId, state]) => {
        if (!driverState[userId]) driverState[userId] = {};
        Object.assign(driverState[userId], state);
      });
      renderDrivers();
    });

    function updateDriverState(userId) {
      db.ref("driverStates/" + userId).set(driverState[userId]);
    }

    function pad2(n){return String(n).padStart(2,'0');}
    function formatTime(sec) {
      const h = String(Math.floor(sec/3600)).padStart(2,'0');
      const m = String(Math.floor((sec%3600)/60)).padStart(2,'0');
      const s = String(sec%60).padStart(2,'0');
      return `${h}:${m}:${s}`;
    }
    function toDisplayDate(isoStr) {
      if (!isoStr) return '';
      const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      const [y, m, d] = isoStr.split('-');
      const mIndex = parseInt(m,10)-1;
      return `${pad2(d)}/${months[mIndex]}/${y}`;
    }

    function renderDrivers() {
      const driverBoard = document.getElementById('driverBoard');
      driverBoard.innerHTML = "";
      Object.entries(allUsers).forEach(([userId, userObj]) => {
        // REMOVED: if (!isAdmin && userObj.name !== currentUser) return;
        if (!driverState[userId]) driverState[userId] = {
          kmIn: "",
          kmOut: "",
          running: false,
          date: (new Date()).toISOString().slice(0,10),
          timer: 0,
          startTime: null,
          stopped: false
        };
        const s = driverState[userId];
        const card = document.createElement('div');
        card.className = 'driver-card' + (s.running ? ' active' : '');
        const headerRow = document.createElement('div');
        headerRow.className = 'driver-card-header';
        const nameEl = document.createElement('span');
        nameEl.className = 'driver-name';
        nameEl.textContent = userObj.name;
        const dateEl = document.createElement('input');
        dateEl.type = 'date';
        dateEl.className = 'driver-date';
        dateEl.value = s.date;
        dateEl.maxLength = 10;
        dateEl.disabled = s.running;
        dateEl.onfocus = function() {
          dateEl.disabled = false;
        };
        dateEl.onblur = function() {
          dateEl.disabled = s.running;
        };
        dateEl.onchange = e => {
          const val = e.target.value.trim();
          if (/^\d{4}-\d{2}-\d{2}$/.test(val)) {
            s.date = val;
            updateDriverState(userId);
            renderDrivers();
          } else {
            e.target.value = s.date;
          }
        };
        dateEl.onclick = function(e) { 
          if(dateEl.disabled) {
            dateEl.disabled = false;
            setTimeout(() => { 
              dateEl.showPicker && dateEl.showPicker(); 
            }, 10);
          } else {
            dateEl.showPicker && dateEl.showPicker();
          } 
        };
        dateEl.onkeyup = function(e) {
          if (!/^\d{4}-\d{2}-\d{2}$/.test(dateEl.value)) {
            dateEl.value = s.date;
          }
        };
        if (isAdmin) {
          const delBtn = document.createElement('button');
          delBtn.className = 'driver-delete';
          delBtn.title = "Remove driver";
          delBtn.innerHTML = "<i class='fas fa-trash'></i>";
          delBtn.onclick = () => showConfirmModal(userId, userObj.name);
          headerRow.appendChild(nameEl);
          headerRow.appendChild(dateEl);
          headerRow.appendChild(delBtn);
        } else {
          headerRow.appendChild(nameEl);
          headerRow.appendChild(dateEl);
        }
        card.appendChild(headerRow);

        const fieldsRow = document.createElement('div');
        fieldsRow.className = 'driver-fields-row';
        const kmInLbl = document.createElement('label');
        kmInLbl.textContent = "In";
        const kmInWrap = document.createElement('span');
        kmInWrap.className = 'input-km-wrap';
        const kmIn = document.createElement('input');
        kmIn.type = 'number';
        kmIn.placeholder = 'Start';
        kmIn.value = s.kmIn;
        kmIn.disabled = s.running;
        kmIn.onfocus = function() {
          kmIn.disabled = false;
        };
        kmIn.onblur = function(e) {
          kmIn.disabled = s.running;
          if (e.target.value.length < 1 || e.target.value.length > 9) return;
          s.kmIn = e.target.value;
          updateDriverState(userId);
          renderKmResult();
        };
        kmIn.onkeypress = e => {
          if (e.key === "Enter" && e.target.value.length >= 1 && e.target.value.length <= 9) {
            s.kmIn = e.target.value;
            updateDriverState(userId);
            renderKmResult();
            kmIn.blur();
          }
        };
        const kmInUnit = document.createElement('span');
        kmInUnit.className = 'km-unit';
        kmInUnit.textContent = "Km";
        kmInWrap.appendChild(kmIn);
        kmInWrap.appendChild(kmInUnit);
        fieldsRow.appendChild(kmInLbl);
        fieldsRow.appendChild(kmInWrap);

        const kmOutLbl = document.createElement('label');
        kmOutLbl.textContent = "Out";
        const kmOutWrap = document.createElement('span');
        kmOutWrap.className = 'input-km-wrap';
        const kmOut = document.createElement('input');
        kmOut.type = 'number';
        kmOut.placeholder = 'End';
        kmOut.value = s.kmOut;
        kmOut.disabled = !s.running;
        kmOut.onfocus = function() {
          kmOut.disabled = false;
        };
        kmOut.onblur = function(e) {
          kmOut.disabled = !s.running;
          if (e.target.value.length < 1 || e.target.value.length > 9) return;
          s.kmOut = e.target.value;
          updateDriverState(userId);
          renderKmResult();
        };
        kmOut.onkeypress = e => {
          if (e.key === "Enter" && e.target.value.length >= 1 && e.target.value.length <= 9) {
            s.kmOut = e.target.value;
            updateDriverState(userId);
            renderKmResult();
            kmOut.blur();
          }
        };
        const kmOutUnit = document.createElement('span');
        kmOutUnit.className = 'km-unit';
        kmOutUnit.textContent = "Km";
        kmOutWrap.appendChild(kmOut);
        kmOutWrap.appendChild(kmOutUnit);
        fieldsRow.appendChild(kmOutLbl);
        fieldsRow.appendChild(kmOutWrap);
        card.appendChild(fieldsRow);

        const kmResult = document.createElement('div');
        kmResult.className = 'driver-km-result';
        function renderKmResult() {
          if(s.kmIn && s.kmOut && 
             !isNaN(+s.kmIn) && !isNaN(+s.kmOut) && 
             +s.kmOut >= +s.kmIn && 
             s.kmIn.length >= 1 && s.kmIn.length <= 9 &&
             s.kmOut.length >= 1 && s.kmOut.length <= 9
          ) {
            kmResult.innerHTML = `<i class="fas fa-road"></i> Today: <span style="font-weight:900;color:var(--primary)">` + (+s.kmOut - +s.kmIn) + ` km</span>`;
          } else { kmResult.textContent = ''; }
        }
        renderKmResult();
        card.appendChild(kmResult);

        const timerBar = document.createElement('div');
        timerBar.className = 'driver-timer-bar';
        const timerDisplay = document.createElement('span');
        timerDisplay.className = 'driver-timer';
        timerDisplay.textContent = formatTime(s.timer);
        timerBar.appendChild(timerDisplay);
        card.appendChild(timerBar);

        const btns = document.createElement('div');
        btns.className = 'driver-btns';
        const startBtn = document.createElement('button');
        startBtn.innerHTML = `<i class="fas fa-play"></i> Start`;
        startBtn.disabled = s.running || !s.kmIn || !s.date || s.kmIn.length < 1 || s.kmIn.length > 9;
        startBtn.onclick = () => {
          s.running = true;
          s.stopped = false;
          s.startTime = new Date().toISOString();
          s.timer = 0;
          updateDriverState(userId);
          timerDisplay.textContent = formatTime(0);
          startBtn.disabled = true;
          stopBtn.disabled = false;
          kmIn.disabled = true;
          kmOut.disabled = false;
          card.classList.add('active');
          if (s.timerInterval) clearInterval(s.timerInterval);
          s.timerInterval = setInterval(() => {
            s.timer = Math.floor((Date.now() - new Date(s.startTime).getTime())/1000);
            timerDisplay.textContent = formatTime(s.timer);
          }, 1000);
        };
        btns.appendChild(startBtn);

        const stopBtn = document.createElement('button');
        stopBtn.innerHTML = `<i class="fas fa-stop"></i> Stop`;
        stopBtn.className = "stop-btn";
        stopBtn.disabled = !s.running || !s.kmOut || s.kmOut.length < 1 || s.kmOut.length > 9;
        stopBtn.onclick = () => {
          if (!s.kmOut || Number(s.kmOut) < Number(s.kmIn)) {
            alert("Enter valid ending km (greater than or equal to start)");
            return;
          }
          if (s.startTime) {
            s.timer = Math.floor((Date.now() - new Date(s.startTime).getTime())/1000);
          }
          s.stopped = true;
          s.running = false;
          s.startTime = null;
          updateDriverState(userId);
          setTimeout(() => {
            s.timer = 0;
            updateDriverState(userId);
          }, 50);
          if (s.timerInterval) clearInterval(s.timerInterval);
          s.timerInterval = null;
          renderKmResult();
          card.classList.remove('active');
          showModal(
            `<b><i class="fas fa-user"></i> ${userObj.name}</b><br>
            <span style="color:#fff;">${toDisplayDate(s.date)}</span><br>
            <span style="color:var(--primary)">Total: ${+s.kmOut - +s.kmIn} km</span><br>
            <span>Time: ${formatTime(s.timer)}</span>`
          );
          db.ref("logs").push({
            date: s.date,
            name: userObj.name,
            kmIn: s.kmIn,
            kmOut: s.kmOut,
            totalKm: (+s.kmOut - +s.kmIn).toString(),
            totalTime: formatTime(s.timer),
            timestamp: new Date().toISOString()
          });
          s.kmIn = ""; s.kmOut = ""; s.startTime = null; s.stopped = false;
          timerDisplay.textContent = formatTime(0);
          updateDriverState(userId);
          renderDrivers();
        };
        btns.appendChild(stopBtn);
        card.appendChild(btns);

        driverBoard.appendChild(card);

        if (s.running && s.startTime && !s.stopped) {
          if (!s.timerInterval) {
            s.timerInterval = setInterval(() => {
              if (!s.stopped) {
                s.timer = Math.floor((Date.now() - new Date(s.startTime).getTime())/1000);
                timerDisplay.textContent = formatTime(s.timer);
              }
            }, 1000);
          }
        } else {
          if (s.timerInterval) {
            clearInterval(s.timerInterval);
            s.timerInterval = null;
          }
          timerDisplay.textContent = formatTime(s.timer || 0);
        }
      });
    }

    setInterval(() => {
      Array.from(driverBoard.children).forEach((card, i) => {
        const userId = Object.keys(allUsers)[i];
        const s = driverState[userId];
        if (!s) return;
        const btns = card.querySelectorAll('.driver-btns button');
        const kmIn = card.querySelector('.driver-fields-row .input-km-wrap input[type="number"]:nth-child(1)');
        const kmOut = card.querySelectorAll('.driver-fields-row .input-km-wrap input[type="number"]')[1];
        const timerDisplay = card.querySelector('.driver-timer');
        if (btns.length === 2) {
          btns[0].disabled = s.running || !s.kmIn || !s.date || s.kmIn.length < 1 || s.kmIn.length > 9;
          btns[1].disabled = !s.running || !s.kmOut || s.kmOut.length < 1 || s.kmOut.length > 9;
        }
        if (kmIn) kmIn.disabled = s.running;
        if (kmOut) kmOut.disabled = !s.running;
        const kmResult = card.querySelector('.driver-km-result');
        if(kmResult) {
          if(s.kmIn && s.kmOut && !isNaN(+s.kmIn) && !isNaN(+s.kmOut) && +s.kmOut >= +s.kmIn && s.kmIn.length >= 1 && s.kmIn.length <= 9 && s.kmOut.length >= 1 && s.kmOut.length <= 9) {
            kmResult.innerHTML = `<i class="fas fa-road"></i> Today: <span style="font-weight:900;color:var(--primary)">` + (+s.kmOut - +s.kmIn) + ` km</span>`;
          } else { kmResult.textContent = ''; }
        }
        if (timerDisplay) {
          timerDisplay.textContent = formatTime(s.stopped ? 0 : (s.timer || 0));
        }
        if (s.running) card.classList.add('active');
        else card.classList.remove('active');
      });
    }, 350);
  </script>
</body>
</html>
