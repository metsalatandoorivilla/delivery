<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>All Drivers KM Reports – Ravintola Tandoori Villa</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>

  <!-- html2pdf for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    :root{
      --main-bg: linear-gradient(135deg,#0d47a1 0%, #000 100%);
      --card-bg: #181c24;
      --primary: #42a5f5;
      --primary-hover: #1976d2;
      --accent: #bbdefb;
      --muted: #98bcd9;
      --border: #212a40;
      --danger: #ff3b30;
      --sheet-header: #373f6b;
      --gap: 16px;
      --radius: 12px;
    }

    html,body{
      margin:0; padding:0; box-sizing:border-box;
      min-height:100vh; width:100vw;
      font-family: 'Poppins', Arial, sans-serif;
      background: var(--main-bg); color:#fff;
    }

    /* Container full width on desktop/tablet/mobile */
    .container{
      max-width: none;
      margin: 10px;
      padding: 12px;
      box-sizing: border-box;
      width: calc(100% - 20px);
    }

    .header{
      background: var(--card-bg);
      padding: 12px;
      border-radius: var(--radius);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border: 1px solid var(--border);
      box-shadow: 0 2px 12px rgba(66,165,245,0.06);
    }
    .header-left { display:flex; align-items:center; gap:12px; }
    .page-title { font-size:1.12rem; font-weight:800; color:#fff; display:flex; align-items:center; gap:10px; }
    .page-desc { color:var(--accent); opacity:0.95; font-weight:500; font-size:0.95rem; }
    #logoutHeader { background: var(--danger); border:none; color:#fff; padding:8px 12px; border-radius:9px; font-weight:700; cursor:pointer; }

    /* Controls area: reorganized to allow mobile two rows */
    .controls-area {
      margin-top: var(--gap);
      display:flex;
      flex-direction:row;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:nowrap;
    }

    .controls-left {
      display:flex; gap:12px; align-items:center; flex-wrap:nowrap;
      min-width: 0;
    }

    label.small { color:var(--muted); font-weight:600; margin-right:6px; font-size:0.95rem; white-space:nowrap; }

    select#driverSelect{
      background:#1d2430; color:#fff; border:1px solid var(--border);
      padding:8px 12px; border-radius:9px; min-width:220px; font-weight:700;
    }

    /* Dark themed rows-per-page select */
    select#rowsPerPage{
      background: #0f1522;
      color: #fff;
      border: 1px solid var(--border);
      padding:8px 10px;
      border-radius:9px;
      font-weight:700;
      appearance: menulist;
      -webkit-appearance: menulist;
      white-space:nowrap;
    }

    .controls-right {
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }

    .actions-top {
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:nowrap;
    }
    .actions-bottom {
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:nowrap;
    }

    .btn {
      background: linear-gradient(90deg,var(--primary),var(--primary-hover));
      color:#fff; border:none; padding:8px 14px; border-radius:9px; cursor:pointer; font-weight:700;
      display:inline-flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    .btn.ghost { background:transparent; border:1px solid var(--border); color:var(--accent); }
    .create-km { background: linear-gradient(90deg,#33c37a,#159a54); }

    .create-full { display:inline-block; }
    .create-short { display:none; }

    .modes { display:flex; gap:8px; flex-wrap:nowrap; white-space:nowrap; overflow-x:auto; -webkit-overflow-scrolling:touch; }
    .mode-btn {
      background: transparent; border:1px solid var(--border); color:var(--accent); padding:8px 12px; border-radius:9px; cursor:pointer; font-weight:700;
      white-space:nowrap;
    }
    .mode-btn.active { background: linear-gradient(90deg,var(--primary),var(--primary-hover)); box-shadow: 0 4px 18px rgba(66,165,245,0.12); color:#fff; }

    /* driver header */
    .driver-header {
      margin-top: var(--gap);
      background: #0f1a36;
      padding:12px 14px;
      border-radius:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border:1px solid var(--border);
    }
    .driver-header .left { font-weight:800; font-size:1.04rem; color:#fff; }
    .driver-header .right { text-align:right; color:var(--accent); font-weight:700; }

    /* table */
    .table-wrap {
      margin-top: 14px;
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 12px;
      border:1px solid var(--border);
      overflow:hidden;
    }

    .table-top {
      display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px;
    }

    .tableMetaSmall {
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }

    .pagination-top { display:flex; gap:8px; align-items:center; }
    .pagination-top button { background:transparent; border:1px solid var(--border); color:var(--accent); padding:6px 10px; border-radius:8px; cursor:pointer; font-weight:700; white-space:nowrap; }
    .pagination-top .pageLabel { font-size:12px; color:var(--muted); white-space:nowrap; }

    .scroll-area { overflow:auto; width:100%; border-radius:8px; }

    /* fixed table layout, center all columns, no wrap */
    table.driver-report-table {
      width:100%;
      min-width:900px;
      border-collapse:separate;
      border-spacing:0;
      font-weight:600;
      table-layout: fixed;
      font-size:13px;
    }
    .driver-report-table thead th {
      background: rgba(255,255,255,0.03);
      color:var(--muted);
      padding:8px 10px;
      text-align:center;
      font-weight:800;
      font-size:0.92rem;
      position:sticky;
      top:0;
      z-index:2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .driver-report-table tbody td {
      padding:8px 10px; color:#eaf6ff; border-bottom:1px solid rgba(255,255,255,0.03); font-weight:600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align:center;
    }
    .driver-report-table tbody tr:nth-child(odd) { background: rgba(255,255,255,0.01); }
    .driver-report-table tbody tr:nth-child(even) { background: rgba(255,255,255,0.00); }

    .small-muted { color:var(--muted); font-weight:600; font-size:0.92rem; }

    /* icons-only actions */
    .action-delete, .action-edit {
      width:36px; height:36px; display:inline-flex; align-items:center; justify-content:center;
      border-radius:8px; cursor:pointer; border:1px solid transparent; background:transparent; color:inherit;
    }
    .action-edit { border-color: rgba(66,165,245,0.22); color:var(--primary); }
    .action-delete { border-color: rgba(255,59,48,0.22); color:var(--danger); }

    /* modals */
    .modal-bg {
      display:none;
      position:fixed; inset:0; z-index:9999;
      background: rgba(13,32,70,0.82);
      align-items:center; justify-content:center;
      padding:16px;
    }
    .modal-bg.active { display:flex; }
    .modal {
      background: var(--card-bg);
      padding:18px;
      border-radius:12px;
      border: 2px solid var(--primary);
      min-width:320px;
      max-width:95vw;
      color:var(--accent);
      box-shadow: 0 8px 28px rgba(0,0,0,0.6);
    }
    .modal .title { font-weight:800; color:#fff; margin-bottom:8px; display:flex; align-items:center; gap:8px; }
    .modal .controls { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
    .modal .controls .btn { padding:8px 12px; }

    .form-row { display:flex; gap:8px; margin-top:8px; align-items:center; }
    .form-row label { min-width:80px; color:var(--muted); font-weight:700; font-size:0.9rem; }
    .form-row input[type="text"], .form-row input[type="number"], .form-row input[type="date"], .form-row input[type="time"], select.modal-dark {
      background:#0f1522; color:#fff; border:1px solid var(--border); padding:8px 10px; border-radius:8px; font-weight:700; width:100%;
    }

    select#modalMonthSelect.modal-dark { background:#0f1626; color:#fff; padding:10px; border-radius:8px; border:1px solid var(--border); }

    /* printable sheet */
    .print-sheet { background:#fff; color:#111; padding:18px; font-family: 'Poppins', Arial, sans-serif; }
    .print-sheet .sheet-header { margin-bottom:12px; }
    .print-sheet .sheet-header .driver-name { font-weight:800; font-size:18px; color:#111; display:block; }
    .print-sheet .sheet-header .driver-details { margin-top:6px; color:#111; font-weight:700; }
    .print-sheet .sheet-header .total-km { margin-top:6px; font-weight:700; color:#111; }

    /* ensure rows do not split across pages */
    .print-sheet table tr, .print-sheet table td, .print-sheet table th {
      page-break-inside: avoid;
      break-inside: avoid;
    }
    thead { display: table-header-group; }
    tfoot { display: table-footer-group; }

    /* responsive: modes on single line, next line actions */
    @media (max-width:900px){
      .controls-area { flex-direction:column; align-items:flex-start; gap:8px; }
      .controls-left { width:100%; display:flex; flex-direction:row; gap:8px; align-items:center; }
      .controls-right { width:100%; display:flex; flex-direction:column; gap:8px; }
      .actions-top { order:0; width:100%; }
      .actions-bottom { order:1; width:100%; }
      .modes { width:100%; }
      /* smaller table paddings */
      table.driver-report-table { font-size:12px; }
    }

    @media (max-width:650px){
      .create-full { display:none; }
      .create-short { display:inline-block; }
      .controls-left { gap:6px; }
      .actions-top { overflow-x:auto; -webkit-overflow-scrolling:touch; }
      .actions-bottom { overflow-x:auto; -webkit-overflow-scrolling:touch; }
      table.driver-report-table { font-size:11px; }
      .driver-report-table thead th, .driver-report-table tbody td { padding:6px 8px; }
      .tableMetaSmall, .pagination-top .pageLabel { font-size:11px; }
    }
  </style>
</head>
<body>
  <div class="container" id="appContainer">
    <div class="header">
      <div class="header-left">
        <div class="page-title"><i class="fas fa-chart-line"></i> All Drivers KM Reports</div>
        <div class="page-desc">Ravintola Tandoori Villa — view, manage and export drivers' KM/time reports</div>
      </div>
      <div class="header-right">
        <button id="logoutHeader">Logout</button>
      </div>
    </div>

    <!-- Controls: top row contains driver + per-page + modes, bottom row contains create/download/delete all (stacked on mobile) -->
    <div class="controls-area">
      <div class="controls-left">
        <label class="small">Driver</label>
        <select id="driverSelect" aria-label="Select driver">
          <option value="__all">All drivers</option>
        </select>

        <label class="small">Per page</label>
        <select id="rowsPerPage" class="rows-per-page" title="Rows per page">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="20">20</option>
          <option value="50">50</option>
        </select>

        <div style="width:8px"></div>

        <div class="modes" role="tablist" aria-label="Mode switch">
          <button class="mode-btn active" id="dailyBtn" role="tab">Daily</button>
          <button class="mode-btn" id="weeklyBtn" role="tab">Last 7 Days</button>
          <button class="mode-btn" id="monthlyBtn" role="tab">Monthly</button>
          <button class="mode-btn" id="customBtn" role="tab">Custom</button>
        </div>
      </div>

      <div class="controls-right">
        <!-- Actions top/bottom so mobile can show modes row then actions row -->
        <div class="actions-top" aria-hidden="true"></div>

        <div class="actions-bottom">
          <button id="createKm" class="btn create-km" title="Create KM table">
            <i class="fas fa-plus-circle"></i>
            <span class="create-full">Create KM Table</span>
            <span class="create-short">Create</span>
          </button>

          <button id="downloadBtn" class="btn" title="Download"><i class="fas fa-file-download"></i> Download</button>

          <button id="deleteAllBtn" class="btn" title="Delete all shown rows" style="background:linear-gradient(90deg,#ff5b5b,#c93535);">
            <i class="fas fa-trash-alt"></i> Delete All
          </button>
        </div>
      </div>
    </div>

    <div id="driverHeaderHolder"></div>

    <div class="table-wrap">
      <div class="table-top">
        <div id="tableMeta" class="tableMetaSmall">No data</div>
        <div class="pagination-top" id="paginationTop"></div>
      </div>

      <div class="scroll-area" id="tableScroll">
        <!-- table injected here always -->
      </div>
    </div>
  </div>

  <!-- Modals -->

  <!-- Month modal -->
  <div class="modal-bg" id="modalMonth">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="title"><i class="far fa-calendar"></i> Select month (months with reports)</div>
      <select id="modalMonthSelect" class="modal-dark" aria-label="Select month">
        <option value="">Loading months…</option>
      </select>
      <div class="controls">
        <button class="btn ghost" id="modalMonthCancel">Cancel</button>
        <button class="btn" id="modalMonthShow">Show</button>
      </div>
    </div>
  </div>

  <!-- Custom date modal -->
  <div class="modal-bg" id="modalCustom">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="title"><i class="far fa-calendar-alt"></i> Custom date range</div>
      <div class="form-row">
        <label>From</label>
        <input id="modalFrom" type="date">
      </div>
      <div class="form-row">
        <label>To</label>
        <input id="modalTo" type="date">
      </div>
      <div class="controls">
        <button class="btn ghost" id="modalCustomCancel">Cancel</button>
        <button class="btn" id="modalCustomShow">Show Table</button>
      </div>
    </div>
  </div>

  <!-- Edit modal (per-row editing) -->
  <div class="modal-bg" id="modalEdit">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="title"><i class="fas fa-edit"></i> Edit log entry</div>

      <div class="form-row">
        <label>Date</label>
        <input id="editDate" type="date">
      </div>
      <div class="form-row">
        <label>KM In</label>
        <input id="editKmIn" type="number" min="0" step="1">
      </div>
      <div class="form-row">
        <label>KM Out</label>
        <input id="editKmOut" type="number" min="0" step="1">
      </div>
      <div class="form-row">
        <label>Time In</label>
        <input id="editTimeIn" type="time">
      </div>
      <div class="form-row">
        <label>Time Out</label>
        <input id="editTimeOut" type="time">
      </div>

      <div id="editError" style="color:var(--danger); margin-top:8px; display:none;"></div>

      <div class="controls">
        <button class="btn ghost" id="modalEditCancel">Cancel</button>
        <button class="btn" id="modalEditSave">Save</button>
      </div>
    </div>
  </div>

  <!-- Download modal -->
  <div class="modal-bg" id="modalDownload">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="title"><i class="fas fa-file-export"></i> Download report</div>
      <div style="display:flex; gap:10px; margin-top:10px;">
        <button id="modalDownloadCsv" class="btn" style="flex:1"><i class="fas fa-file-csv"></i> CSV</button>
        <button id="modalDownloadPdf" class="btn" style="flex:1"><i class="fas fa-file-pdf"></i> PDF</button>
      </div>
      <div class="controls">
        <button class="btn ghost" id="modalDownloadCancel">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Confirm modal (delete single and delete all) -->
  <div class="modal-bg" id="modalConfirm">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="title"><i class="fas fa-exclamation-triangle" style="color:var(--danger)"></i> Confirm</div>
      <div id="modalConfirmDetails" style="color:var(--accent); margin-top:6px;">Are you sure?</div>
      <div class="controls">
        <button class="btn ghost" id="modalConfirmCancel">Cancel</button>
        <button class="btn" id="modalConfirmOk">Delete</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- Auth & Firebase ----------
    const userData = JSON.parse(localStorage.getItem('user') || 'null');
    if (!userData || userData.role !== 'admin') {
      window.location.href = 'login.html';
    }
    const currentAdmin = userData.name || 'admin';

    const firebaseConfig = {
      apiKey: "AIzaSyCirYQ_46JiSkMIwCNs1nSi89dvB1MUg_A",
      authDomain: "deliverylog12.firebaseapp.com",
      databaseURL: "https://deliverylog12-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "deliverylog12",
      storageBucket: "deliverylog12.firebasestorage.app",
      messagingSenderId: "19081371357",
      appId: "1:19081371357:web:b9b59e732a4d90d4d44534",
      measurementId: "G-FSZXXZQSL0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ---------- State ----------
    let allUsers = {};
    let allLogs = {};
    let selectedDriver = "__all"; // userId or "__all"
    let currentMode = 'daily';
    let currentMonth = '';
    let modalFrom = '';
    let modalTo = '';
    let currentPage = 1;
    let rowsPerPage = parseInt(document.getElementById('rowsPerPage').value,10) || 10;
    let totalPages = 1;
    let confirmCallback = null;
    let currentEditId = null;

    // DOM refs
    const driverSelect = document.getElementById('driverSelect');
    const driverHeaderHolder = document.getElementById('driverHeaderHolder');
    const tableScroll = document.getElementById('tableScroll');
    const paginationTop = document.getElementById('paginationTop');
    const tableMeta = document.getElementById('tableMeta');
    const modalMonth = document.getElementById('modalMonth');
    const modalMonthSelect = document.getElementById('modalMonthSelect');
    const deleteAllBtn = document.getElementById('deleteAllBtn');

    // helpers
    function pad2(n){ return String(n).padStart(2,'0'); }
    function todayISO(){ return (new Date()).toISOString().slice(0,10); }
    function addDays(iso, n){
      const d = new Date(iso + 'T00:00:00');
      d.setDate(d.getDate() + n);
      return d.toISOString().slice(0,10);
    }
    function toDisplayDate(iso){
      if(!iso) return '';
      const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      const [y,m,d] = iso.split('-');
      return `${pad2(d)}/${months[parseInt(m,10)-1]}/${y}`;
    }
    function escapeHtml(s){
      if(s === null || s === undefined) return '';
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }
    function sumKm(arr){
      return arr.reduce((acc, r) => {
        const n = parseInt(r.totalKm ?? (((Number(r.kmOut) || 0) - (Number(r.kmIn) || 0)).toString()), 10);
        return acc + (isNaN(n) ? 0 : n);
      }, 0);
    }

    // returns flat array of logs filtered by selectedDriver (userId or name fallback)
    function logsArrayFilteredByDriver(driverId){
      const arr = Object.entries(allLogs).map(([id,obj]) => Object.assign({}, obj, { id }));
      if(driverId && driverId !== "__all"){
        const driverName = (allUsers[driverId] && allUsers[driverId].name) || null;
        return arr.filter(x => {
          if(x.userId && x.userId === driverId) return true;
          if(driverName && x.name && x.name === driverName) return true;
          return false;
        }).sort((a,b) => {
          if(a.date === b.date) return (b.timestamp||'').localeCompare(a.timestamp||'');
          return b.date.localeCompare(a.date);
        });
      }
      // "__all" - return everything sorted
      return arr.sort((a,b) => {
        if(a.date === b.date) return (b.timestamp||'').localeCompare(a.timestamp||'');
        return b.date.localeCompare(a.date);
      });
    }

    // Build grouped rows by date: returns [{ date: 'YYYY-MM-DD', logs: [ ... ] }, ...] descending by date
    function getRows(mode){
      const arr = logsArrayFilteredByDriver(selectedDriver);
      const map = {};
      const push = (log) => {
        const dt = log.date || todayISO();
        if(!map[dt]) map[dt] = [];
        map[dt].push(log);
      };

      if(mode === 'daily'){
        const d = todayISO();
        arr.forEach(l => { if(l.date === d) push(l); });
      } else if(mode === 'weekly'){
        const t = todayISO();
        const last7 = new Set(); for(let i=0;i<7;i++) last7.add(addDays(t, -i));
        arr.forEach(l => { if(last7.has(l.date)) push(l); });
      } else if(mode === 'monthly'){
        if(!currentMonth) currentMonth = getAvailableMonthsForDriver(selectedDriver)[0] || todayISO().slice(0,7);
        arr.forEach(l => { if(l.date && l.date.slice(0,7) === currentMonth) push(l); });
      } else if(mode === 'custom'){
        if(!modalFrom || !modalTo) {
          // nothing
        } else {
          arr.forEach(l => { if(l.date >= modalFrom && l.date <= modalTo) push(l); });
        }
      } else {
        arr.forEach(l => push(l));
      }

      const dates = Object.keys(map).sort((a,b) => b.localeCompare(a));
      return dates.map(d => ({ date: d, logs: map[d] }));
    }

    function getAvailableMonthsForDriver(driverId){
      const months = new Set();
      const arr = logsArrayFilteredByDriver(driverId);
      arr.forEach(l => { if(l.date && l.date.length >= 7) months.add(l.date.slice(0,7)); });
      return Array.from(months).sort((a,b) => b.localeCompare(a));
    }

    // ---------- Rendering ----------
    function renderDriverHeader(totalKm, periodText){
      if(selectedDriver === "__all"){
        driverHeaderHolder.innerHTML = `<div class="driver-header"><div class="left">All Drivers</div><div class="right">${escapeHtml(periodText)}<div style="font-size:0.88rem;margin-top:6px;">Total KM: <span style="color:var(--primary); font-weight:900;">${totalKm} km</span></div></div></div>`;
      } else {
        const user = allUsers[selectedDriver] || {};
        const name = user.name || '—';
        driverHeaderHolder.innerHTML = `<div class="driver-header"><div class="left">${escapeHtml(name)}</div><div class="right">${escapeHtml(periodText)}<div style="font-size:0.88rem;margin-top:6px;">Total KM: <span style="color:var(--primary); font-weight:900;">${totalKm} km</span></div></div></div>`;
      }
    }

    function renderPaginationTop(page, total){
      paginationTop.innerHTML = '';
      const prev = document.createElement('button');
      prev.textContent = 'Previous';
      prev.disabled = page <= 1;
      prev.onclick = () => { if(page>1){ currentPage--; renderReportsView(); } };
      const pageLabel = document.createElement('span');
      pageLabel.className = 'pageLabel';
      pageLabel.textContent = `Page ${page} / ${total}`;
      const next = document.createElement('button');
      next.textContent = 'Next';
      next.disabled = page >= total;
      next.onclick = () => { if(page<total){ currentPage++; renderReportsView(); } };
      paginationTop.appendChild(prev);
      paginationTop.appendChild(pageLabel);
      paginationTop.appendChild(next);
    }

    // Render desktop-style table; hides Driver column when a specific driver is selected
    function renderDesktop(logs) {
      const showDriverCol = (selectedDriver === "__all");

      totalPages = Math.max(1, Math.ceil(logs.length / rowsPerPage));
      if (currentPage > totalPages) currentPage = totalPages;
      const start = (currentPage - 1) * rowsPerPage;
      const pageItems = logs.slice(start, start + rowsPerPage);

      // Build header dynamically
      let headerCols = [];
      headerCols.push({ key: 'date', title: 'Date', width: '110px' });
      if(showDriverCol) headerCols.push({ key: 'driver', title: 'Driver', width: '200px' });
      headerCols.push({ key: 'kmin', title: 'KM In', width: '90px' });
      headerCols.push({ key: 'kmout', title: 'KM Out', width: '90px' });
      headerCols.push({ key: 'totalkm', title: 'Total KM', width: '90px' });
      headerCols.push({ key: 'timein', title: 'Time In', width: '100px' });
      headerCols.push({ key: 'timeout', title: 'Time Out', width: '100px' });
      headerCols.push({ key: 'actions', title: 'Actions', width: '80px' });

      let html = `<table class="driver-report-table" role="table" aria-label="Drivers report">
        <thead><tr>`;
      headerCols.forEach(c => {
        html += `<th style="width:${c.width}">${escapeHtml(c.title)}</th>`;
      });
      html += `</tr></thead><tbody>`;

      pageItems.forEach(log => {
        const driverName = (allUsers[log.userId] && allUsers[log.userId].name) || log.name || '—';
        const kmIn = log.kmIn || '';
        const kmOut = log.kmOut || '';
        const totalKmCell = (log.totalKm !== undefined && log.totalKm !== null) ? log.totalKm : ((Number(kmOut)||0) - (Number(kmIn)||0));
        const timeIn = log.timeIn || '';
        const timeOut = log.timeOut || '';

        html += `<tr data-log-id="${escapeHtml(log.id)}">`;
        // date
        html += `<td>${escapeHtml(toDisplayDate(log.date || ''))}</td>`;
        // driver (conditionally)
        if(showDriverCol) html += `<td>${escapeHtml(driverName)}</td>`;
        // other columns
        html += `<td>${escapeHtml(kmIn)}</td>
                 <td>${escapeHtml(kmOut)}</td>
                 <td>${escapeHtml(String(totalKmCell))}</td>
                 <td>${escapeHtml(timeIn)}</td>
                 <td>${escapeHtml(timeOut)}</td>
                 <td>
                   <button class="action-edit" data-log="${escapeHtml(log.id)}" title="Edit"><i class="fas fa-edit"></i></button>
                   <button class="action-delete" data-log="${escapeHtml(log.id)}" title="Delete"><i class="fas fa-trash"></i></button>
                 </td>`;
        html += `</tr>`;
      });

      html += `</tbody></table>`;
      tableScroll.innerHTML = html;

      tableMeta.textContent = `${logs.length} record(s) — mode: ${currentMode}`;

      // attach edit handlers
      tableScroll.querySelectorAll('.action-edit').forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute('data-log');
          openEditModal(id);
        };
      });

      // attach delete handlers
      tableScroll.querySelectorAll('.action-delete').forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute('data-log');
          const tr = btn.closest('tr');
          // When driver column hidden, name may not be in column 1; we try to read by looking up log data
          let name = '';
          const logObj = allLogs[id] || {};
          if(logObj && (logObj.userId || logObj.name)) {
            name = (allUsers[logObj.userId] && allUsers[logObj.userId].name) || logObj.name || '';
          } else if(tr) {
            // fallback: second cell might be driver if visible
            try { name = tr.children[1] ? tr.children[1].textContent : ''; } catch(e){}
          }
          showConfirm(`Delete log for <b>${escapeHtml(name)}</b>? This cannot be undone.`, async () => {
            await db.ref('logs/' + id).remove();
            hideConfirm();
          });
        };
      });

      renderPaginationTop(currentPage, totalPages);
    }

    function renderReportsView(){
      rowsPerPage = parseInt(document.getElementById('rowsPerPage').value,10) || 10;
      const grouped = getRows(currentMode); // [{date, logs:[]}, ...]
      const flattened = grouped.flatMap(g => g.logs);
      const totalKm = sumKm(flattened);

      let periodText = '';
      if(currentMode === 'daily'){ periodText = toDisplayDate(todayISO()); }
      else if(currentMode === 'weekly'){ const t = todayISO(); const f = addDays(t, -6); periodText = `${toDisplayDate(f)} — ${toDisplayDate(t)}`; }
      else if(currentMode === 'monthly'){ periodText = currentMonth ? currentMonth : (getAvailableMonthsForDriver(selectedDriver)[0] || ''); periodText = periodText ? (periodText.split('-').join('/')) : 'Month'; }
      else if(currentMode === 'custom'){ periodText = modalFrom && modalTo ? `${toDisplayDate(modalFrom)} — ${toDisplayDate(modalTo)}` : 'Custom'; }

      renderDriverHeader(totalKm, periodText);

      // Always render desktop table view (full width table on all devices)
      renderDesktop(flattened);
    }

    // ---------- Edit modal logic ----------
    function openEditModal(id){
      const log = allLogs[id];
      if(!log) return alert('Log not found');
      currentEditId = id;
      document.getElementById('editDate').value = log.date || '';
      document.getElementById('editKmIn').value = log.kmIn || '';
      document.getElementById('editKmOut').value = log.kmOut || '';
      document.getElementById('editTimeIn').value = log.timeIn || '';
      document.getElementById('editTimeOut').value = log.timeOut || '';
      document.getElementById('editError').style.display = 'none';
      document.getElementById('modalEdit').classList.add('active');
      setTimeout(() => document.getElementById('editDate').focus(), 120);
    }

    document.getElementById('modalEditCancel').onclick = () => {
      currentEditId = null;
      document.getElementById('modalEdit').classList.remove('active');
    };

    document.getElementById('modalEdit').onclick = (e) => {
      if(e.target === document.getElementById('modalEdit')) {
        currentEditId = null;
        document.getElementById('modalEdit').classList.remove('active');
      }
    };

    document.getElementById('modalEditSave').onclick = async () => {
      const id = currentEditId;
      if(!id) return;
      const date = document.getElementById('editDate').value;
      const kmIn = document.getElementById('editKmIn').value;
      const kmOut = document.getElementById('editKmOut').value;
      const timeIn = document.getElementById('editTimeIn').value;
      const timeOut = document.getElementById('editTimeOut').value;

      if(!date){ showEditError('Date is required'); return; }
      if(kmIn === '' || kmOut === ''){ showEditError('KM In and KM Out are required'); return; }
      if(Number(kmOut) < Number(kmIn)){ showEditError('KM Out must be greater than or equal to KM In'); return; }

      const totalKm = String(Number(kmOut) - Number(kmIn));

      try {
        await db.ref('logs/' + id).update({
          date,
          kmIn: String(kmIn),
          kmOut: String(kmOut),
          timeIn: timeIn || '',
          timeOut: timeOut || '',
          totalKm: totalKm
        });
        document.getElementById('modalEdit').classList.remove('active');
        currentEditId = null;
      } catch(err){
        console.error('Update failed', err);
        showEditError('Save failed, try again');
      }
    };

    function showEditError(msg){
      const el = document.getElementById('editError');
      el.textContent = msg;
      el.style.display = 'block';
    }

    // ---------- Downloads ----------
    function downloadCSV(){
      const grouped = getRows(currentMode);
      const flattened = grouped.flatMap(g => g.logs);
      const header = ['Date','Driver','KM In','KM Out','Total KM','Time In','Time Out'];
      const rows = [header];
      flattened.forEach(r => {
        const driver = (allUsers[r.userId] && allUsers[r.userId].name) || r.name || '';
        const kmIn = r.kmIn || '';
        const kmOut = r.kmOut || '';
        const total = r.totalKm !== undefined ? r.totalKm : ((Number(kmOut)||0) - (Number(kmIn)||0));
        rows.push([r.date || '', driver, kmIn, kmOut, String(total), r.timeIn || '', r.timeOut || '']);
      });
      const csv = rows.map(r => r.map(cell => {
        const s = String(cell ?? '');
        if(s.includes('"') || s.includes(',') || s.includes('\n')) return `"${s.replace(/"/g,'""')}"`;
        return s;
      }).join(',')).join('\n');

      const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
      const filename = `reports_${selectedDriver === '__all' ? 'all' : (allUsers[selectedDriver] && allUsers[selectedDriver].name || selectedDriver)}_${new Date().toISOString().slice(0,10)}.csv`;
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    // PDF helper: driver name + details + total km plain bold (no boxed badge), avoid row splitting
    function downloadReportPdf({ selectedDriverName, allUsers, groupedRows, currentMode, currentMonth, filenamePrefix }){
      function pad2(n){ return String(n).padStart(2,'0'); }
      function toDisplayDateLocal(iso){
        if(!iso) return '';
        const [y,m,d] = iso.split('-');
        const MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
        return `${pad2(d)}/${MONTHS[parseInt(m,10)-1]}/${y}`;
      }
      function escapeHtmlLocal(s){ if(s==null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
      function sumKmLocal(rows){ return rows.reduce((s,r)=> s + (parseInt(r.totalKm||(((Number(r.kmOut)||0)-(Number(r.kmIn)||0)).toString()),10)||0), 0); }

      const rows = (groupedRows || []).flatMap(g => g.logs || []);
      const totalKm = sumKmLocal(rows);
      let periodText = '';
      if(currentMode === 'weekly'){ periodText = 'Last 7 days'; }
      else if(currentMode === 'monthly'){
        const m = currentMonth || ((groupedRows && groupedRows[0] && groupedRows[0].date) ? groupedRows[0].date.slice(0,7) : '');
        periodText = m ? (new Date(m + '-01')).toLocaleString('default',{ month: 'long', year: 'numeric' }) : 'Monthly';
      } else {
        const dates = (groupedRows || []).map(g => g.date).sort();
        if(dates.length) periodText = `${toDisplayDateLocal(dates[dates.length-1])} — ${toDisplayDateLocal(dates[0])}`;
        else periodText = '—';
      }

      const driverObj = Object.values(allUsers || {}).find(u => u.name === selectedDriverName) || {};

      const printable = document.createElement('div');
      printable.className = 'print-sheet';
      printable.style.boxSizing = 'border-box';

      // Header: plain bold lines, no boxed total
      printable.innerHTML = `
        <div class="sheet-header">
          <div class="driver-name">${escapeHtmlLocal(selectedDriverName || '')}</div>
          <div class="driver-details">${escapeHtmlLocal(driverObj.car || '')}${driverObj.car ? '  ' : ''}${escapeHtmlLocal(driverObj.address || '')}</div>
          <div class="total-km"><strong>Total KM: ${totalKm} km</strong></div>
          <div class="period" style="margin-top:6px;">${escapeHtmlLocal(periodText)}</div>
        </div>

        <table id="printTable" style="width:100%;border-collapse:collapse;font-size:12px;">
          <thead>
            <tr>
              <th style="background:#373f6b;color:#fff;padding:8px 10px;text-align:center">Date</th>
              <th style="background:#373f6b;color:#fff;padding:8px 10px;text-align:center">Km In</th>
              <th style="background:#373f6b;color:#fff;padding:8px 10px;text-align:center">Km Out</th>
              <th style="background:#373f6b;color:#fff;padding:8px 10px;text-align:center">Total KM</th>
              <th style="background:#373f6b;color:#fff;padding:8px 10px;text-align:center">Time In</th>
              <th style="background:#373f6b;color:#fff;padding:8px 10px;text-align:center">Time Out</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map((r, i) => {
              const kmIn = r.kmIn || '';
              const kmOut = r.kmOut || '';
              const total = r.totalKm !== undefined ? r.totalKm : ((Number(kmOut)||0) - (Number(kmIn)||0));
              return `<tr style="background:${ i % 2 ? 'rgba(0,0,0,0.03)' : '#ffffff'}">
                <td style="padding:8px 10px;text-align:center;color:#111">${escapeHtmlLocal(toDisplayDateLocal(r.date))}</td>
                <td style="padding:8px 10px;text-align:center;color:#111">${escapeHtmlLocal(kmIn)}</td>
                <td style="padding:8px 10px;text-align:center;color:#111">${escapeHtmlLocal(kmOut)}</td>
                <td style="padding:8px 10px;text-align:center;color:#111">${escapeHtmlLocal(String(total))}</td>
                <td style="padding:8px 10px;text-align:center;color:#111">${escapeHtmlLocal(r.timeIn || '')}</td>
                <td style="padding:8px 10px;text-align:center;color:#111">${escapeHtmlLocal(r.timeOut || '')}</td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      `;

      // Prevent row splitting
      const style = document.createElement('style');
      style.innerHTML = `
        .print-sheet table tr, .print-sheet table td, .print-sheet table th {
          page-break-inside: avoid !important;
          break-inside: avoid !important;
        }
        thead { display: table-header-group; } 
        tfoot { display: table-footer-group; }
      `;
      printable.prepend(style);

      document.body.appendChild(printable);

      const filename = (filenamePrefix ? filenamePrefix.replace(/\s+/g,'_') + '_' : '') +
                       (selectedDriverName ? selectedDriverName.replace(/\s+/g,'_') + '_' : '') +
                       (new Date()).toISOString().slice(0,10) + '.pdf';

      const opt = {
        margin: [10, 10, 18, 10],
        filename: filename,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['css', 'legacy'] }
      };

      html2pdf().set(opt).from(printable).toPdf().get('pdf').then(function(pdf) {
        const totalPages = pdf.internal.getNumberOfPages();
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        pdf.setFontSize(10);
        for (let i = 1; i <= totalPages; i++) {
          pdf.setPage(i);
          const footer = `Page ${i} of ${totalPages}`;
          pdf.text(footer, pageWidth / 2, pageHeight - 8, { align: 'center' });
        }
        pdf.save(opt.filename);
      }).catch(function(err){
        console.error('html2pdf error', err);
        alert('PDF generation failed: ' + (err && err.message ? err.message : 'unknown error'));
      }).finally(function(){
        try { document.body.removeChild(printable); } catch(e){}
      });
    }

    // ---------- Confirm modal ----------
    function showConfirm(htmlDetails, onOk, okLabel = 'Delete', cancelLabel = 'Cancel'){
      document.getElementById('modalConfirmDetails').innerHTML = htmlDetails;
      document.getElementById('modalConfirmOk').textContent = okLabel;
      document.getElementById('modalConfirmCancel').textContent = cancelLabel;
      document.getElementById('modalConfirm').classList.add('active');
      confirmCallback = onOk;
      setTimeout(() => document.getElementById('modalConfirmOk').focus(), 120);
    }
    function hideConfirm(){
      document.getElementById('modalConfirm').classList.remove('active');
      confirmCallback = null;
    }

    document.getElementById('modalConfirmCancel').onclick = hideConfirm;
    document.getElementById('modalConfirmOk').onclick = async () => {
      if(typeof confirmCallback === 'function') {
        try {
          await confirmCallback();
        } catch(err) {
          console.error(err);
        } finally {
          hideConfirm();
        }
      } else hideConfirm();
    };
    document.getElementById('modalConfirm').onclick = (e) => { if(e.target === document.getElementById('modalConfirm')) hideConfirm(); };

    // ---------- Events ----------
    driverSelect.onchange = function(e){
      selectedDriver = e.target.value;
      populateMonthModal();
      currentPage = 1;
      renderReportsView();
    };

    document.getElementById('rowsPerPage').onchange = function(){
      rowsPerPage = parseInt(this.value,10) || 10;
      currentPage = 1;
      renderReportsView();
    };

    const modeButtons = {
      daily: document.getElementById('dailyBtn'),
      weekly: document.getElementById('weeklyBtn'),
      monthly: document.getElementById('monthlyBtn'),
      custom: document.getElementById('customBtn')
    };
    function setActiveMode(mode){
      currentMode = mode;
      Object.values(modeButtons).forEach(b => b.classList.remove('active'));
      if(modeButtons[mode]) modeButtons[mode].classList.add('active');

      if(mode === 'monthly'){
        populateMonthModal();
        document.getElementById('modalMonth').classList.add('active');
      } else if(mode === 'custom'){
        document.getElementById('modalCustom').classList.add('active');
      } else {
        currentPage = 1;
        renderReportsView();
      }
    }
    modeButtons.daily.onclick = () => setActiveMode('daily');
    modeButtons.weekly.onclick = () => setActiveMode('weekly');
    modeButtons.monthly.onclick = () => setActiveMode('monthly');
    modeButtons.custom.onclick = () => setActiveMode('custom');

    function populateMonthModal(){
      const months = getAvailableMonthsForDriver(selectedDriver);
      modalMonthSelect.innerHTML = '';
      if(months.length === 0){
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'No months available';
        modalMonthSelect.appendChild(opt);
        modalMonthSelect.disabled = true;
      } else {
        modalMonthSelect.disabled = false;
        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'Choose month';
        modalMonthSelect.appendChild(placeholder);
        months.forEach(m => {
          const [y, mm] = m.split('-');
          const d = new Date(y, Number(mm)-1, 1);
          const text = `${d.toLocaleString(undefined,{month:'short'})} ${y}`;
          const opt = document.createElement('option');
          opt.value = m;
          opt.textContent = text + ' (' + m + ')';
          modalMonthSelect.appendChild(opt);
        });
      }
    }
    document.getElementById('modalMonthCancel').onclick = () => modalMonth.classList.remove('active');
    document.getElementById('modalMonthShow').onclick = () => {
      const v = modalMonthSelect.value;
      if(!v){ alert('Choose a month'); return; }
      currentMonth = v;
      modalMonth.classList.remove('active');
      currentPage = 1;
      renderReportsView();
    };
    modalMonth.onclick = (e) => { if(e.target === modalMonth) modalMonth.classList.remove('active'); };

    document.getElementById('modalCustomCancel').onclick = () => document.getElementById('modalCustom').classList.remove('active');
    document.getElementById('modalCustomShow').onclick = () => {
      const f = document.getElementById('modalFrom').value;
      const t = document.getElementById('modalTo').value;
      if(!f || !t){ alert('Select both From and To'); return; }
      if(f > t){ alert('From must be before or equal To'); return; }
      modalFrom = f; modalTo = t;
      document.getElementById('modalCustom').classList.remove('active'); // close popup as requested
      currentMode = 'custom';
      Object.values(modeButtons).forEach(b => b.classList.remove('active'));
      if(modeButtons.custom) modeButtons.custom.classList.add('active');
      currentPage = 1;
      renderReportsView();
    };
    document.getElementById('modalCustom').onclick = (e) => { if(e.target === document.getElementById('modalCustom')) document.getElementById('modalCustom').classList.remove('active'); };

    document.getElementById('downloadBtn').onclick = () => {
      document.getElementById('modalDownload').classList.add('active');
      setTimeout(()=> document.getElementById('modalDownloadCsv').focus(), 120);
    };
    document.getElementById('modalDownloadCancel').onclick = () => document.getElementById('modalDownload').classList.remove('active');
    document.getElementById('modalDownloadCsv').onclick = () => {
      document.getElementById('modalDownload').classList.remove('active');
      downloadCSV();
    };
    document.getElementById('modalDownloadPdf').onclick = async () => {
      document.getElementById('modalDownload').classList.remove('active');
      const groupedRows = getRows(currentMode);
      const selectedDriverName = selectedDriver === '__all' ? 'All drivers' : (allUsers[selectedDriver] && allUsers[selectedDriver].name) || '';
      downloadReportPdf({
        selectedDriverName,
        allUsers,
        groupedRows,
        currentMode,
        currentMonth,
        filenamePrefix: 'report'
      });
    };
    document.getElementById('modalDownload').onclick = (e) => { if(e.target === document.getElementById('modalDownload')) document.getElementById('modalDownload').classList.remove('active'); };

    document.getElementById('createKm').onclick = () => window.location.href = 'kmtable.html';

    document.getElementById('logoutHeader').onclick = () => {
      if(confirm('Logout?')){
        localStorage.removeItem('user');
        window.location.href = 'login.html';
      }
    };

    // Delete All shown rows button - ask confirmation and delete only currently filtered rows
    deleteAllBtn.onclick = () => {
      const grouped = getRows(currentMode);
      const flattened = grouped.flatMap(g => g.logs);
      if(flattened.length === 0){ alert('No rows to delete for the current filter/mode'); return; }
      showConfirm(`Delete ALL (${flattened.length}) shown records? This cannot be undone.`, async () => {
        const ids = flattened.map(r => r.id).filter(Boolean);
        const batchSize = 50;
        for(let i=0;i<ids.length;i+=batchSize){
          const batch = ids.slice(i, i+batchSize);
          await Promise.all(batch.map(id => db.ref('logs/' + id).remove().catch(err => { console.error('Failed to remove', id, err); })));
        }
        hideConfirm();
      }, 'Delete All', 'Cancel');
    };

    // re-render on resize
    window.addEventListener('resize', () => {
      clearTimeout(window._renderResizeTimer);
      window._renderResizeTimer = setTimeout(() => renderReportsView(), 120);
    });

    // ---------- Firebase listeners ----------
    db.ref('users').on('value', snap => {
      allUsers = snap.val() || {};
      const prev = selectedDriver;
      const keys = Object.keys(allUsers).sort((a,b) => (allUsers[a].name||'').localeCompare(allUsers[b].name||''));
      driverSelect.innerHTML = `<option value="__all">All drivers</option>`;
      keys.forEach(uid => {
        const opt = document.createElement('option');
        opt.value = uid;
        opt.textContent = allUsers[uid].name || uid;
        driverSelect.appendChild(opt);
      });
      if(prev && (prev === '__all' || allUsers[prev])) {
        selectedDriver = prev;
      } else {
        selectedDriver = keys[0] || '__all';
      }
      driverSelect.value = selectedDriver;
      populateMonthModal();
      renderReportsView();
    });

    db.ref('logs').on('value', snap => {
      allLogs = snap.val() || {};
      populateMonthModal();
      renderReportsView();
    });

    // ---------- Initial setup ----------
    (function init(){
      setActiveMode('daily');
      rowsPerPage = parseInt(document.getElementById('rowsPerPage').value,10) || 10;
    })();
  </script>
</body>
</html>
